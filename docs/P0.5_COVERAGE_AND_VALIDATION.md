# P0.5 Core Coverage ≥80% + Go/No-Go Validation

## Overview

This document describes the implementation of P0.5, which provides comprehensive test coverage (≥80%) for core modules and a Go/No-Go validation harness to ensure the AI Quality Kit system is production-ready.

## Implementation Summary

### ✅ Core Test Coverage

**Target Modules:**
- `apps/server/guardrails/aggregator.py` - Guardrails orchestration
- `apps/server/guardrails/providers/` - Individual provider implementations  
- `apps/orchestrator/deduplication.py` - Cross-suite deduplication
- `apps/orchestrator/run_tests.py` - Test execution orchestration
- `apps/reporters/` - Report generation

**Test Files Created:**
1. `tests/test_guardrails_aggregator_comprehensive.py` - 50+ test cases covering:
   - Provider planning and configuration
   - Threshold merging (server defaults + client overrides)
   - Mode enforcement (hard_gate/mixed/advisory)
   - Deduplication paths and caching
   - Run manifest generation
   - Privacy compliance

2. `tests/test_guardrails_providers_comprehensive.py` - 40+ test cases covering:
   - Happy path → normalized 0..1 scores, stable labels
   - Missing dependencies → unavailable labels with graceful degradation
   - Privacy compliance (no raw text in results/logs)
   - PI quickset deterministic ASR computation
   - Schema validation, performance metrics, toxicity detection

3. `tests/test_orchestrator_wiring_comprehensive.py` - 30+ test cases covering:
   - Preflight pre-run hook enforcement
   - Payload parity with Classic (additive fields only)
   - Cross-suite deduplication (Safety/Red Team reuse Preflight signals)
   - Estimator exclusion of reused items

4. `tests/test_redteam_corpus_integration.py` - 50+ test cases covering:
   - Built-in corpus loading (version/hash validation)
   - User corpus validation and merging with provenance
   - Mutator deterministic variant generation
   - Deduplication with quickset overlap detection
   - ASR metrics and coverage tables

### ✅ Go/No-Go Validation Harness

**Script:** `scripts/go_no_go_validation.py`
**Make Target:** `make go-no-go`

**Test Sequence:**
1. `GET /guardrails/health` → Verify providers flagged correctly
2. `POST /guardrails/preflight` (hard_gate) → Deterministic PASS scenario
3. `POST /guardrails/preflight` (hard_gate) → Deterministic FAIL scenario  
4. `POST /guardrails/preflight` (unavailable provider) → Graceful degradation
5. `POST /testdata/*` → Inline intake (RAG + Red Team)
6. `POST /orchestrator/run_tests` (respect_guardrails=true) → Dedupe + gating
7. Reports v2 generation → Required sheets + "Reused" markers

**Artifacts Generated:**
- JSON artifacts for each test step
- Validation summary with pass/fail status
- Deterministic results with fixed seeds
- Concise Markdown summary

### ✅ Coverage Gate

**Make Target:** `make test-coverage`
**Environment Variable:** `COVERAGE_ENFORCE=1` (enables 80% minimum)

```bash
# Run with enforcement
COVERAGE_ENFORCE=1 make test-coverage

# Run without enforcement (reporting only)
make test-coverage
```

## Key Features Validated

### 1. Guardrails Aggregator
- ✅ Provider plan builds correctly for given rules/modes
- ✅ Thresholds merge server defaults + client overrides  
- ✅ Modes enforce decisions (hard_gate blocks all; mixed blocks criticals; advisory annotates)
- ✅ Dedupe paths: fingerprint cache hit → skip execution; "reused" surfaces in response
- ✅ Run manifest: provider versions, thresholds, rule-set hash present

### 2. Providers (Each)
- ✅ Happy path → normalized 0..1, stable labels
- ✅ Missing-dep → label=unavailable, details.missing_dep=true, 200 response
- ✅ Privacy: results/logs contain no raw text (assertions included)
- ✅ PI quickset: ASR PASS/FAIL cases with stub SUT; deterministic subset

### 3. Orchestrator Wiring  
- ✅ Preflight pre-run hook enforces gate (hard blocks all; mixed blocks criticals; advisory annotates)
- ✅ Payload parity with Classic (additive fields only: guardrails_config, respect_guardrails)
- ✅ Cross-suite dedupe: Safety/Red Team reuse Preflight signals (no re-exec; estimator excludes)

### 4. Red Team Large Corpus
- ✅ Loader: built-in corpus loads (version/hash), user corpus validates; merge preserves provenance
- ✅ Selection: diversity across family/technique/lang/channel; mutators generate deterministic variant_id
- ✅ Dedupe: items overlapping quickset are marked "Reused" and not executed
- ✅ Metrics: overall/per-family ASR; Coverage table accurate

### 5. Reports v2
- ✅ Sheets present: Summary, Detailed, API_Details, Inputs_And_Expected, Adversarial_Details, Coverage, Guardrails_Details, Performance
- ✅ "Reused" markers show up; PII masking verified; JSON/XLSX parity

### 6. Inline Intake (Phase 3.1)
- ✅ Upload/URL/Paste happy paths + schema violations (readable errors)
- ✅ Ephemeral testdata_id honored; no persistence; no raw-text logs

### 7. Performance/Privacy
- ✅ Preflight added p95 overhead within budget (≤~350 ms with current sampling)
- ✅ Logs: assert no raw prompts/outputs anywhere

## Usage Examples

### Running Coverage Tests
```bash
# With 80% enforcement
COVERAGE_ENFORCE=1 make test-coverage

# View HTML coverage report
open htmlcov/index.html
```

### Running Go/No-Go Validation
```bash
# Full validation harness
make go-no-go

# Custom configuration
python scripts/go_no_go_validation.py --verbose --output-dir custom_results --base-url http://localhost:8000
```

### Running Specific Test Suites
```bash
# Guardrails aggregator tests
pytest tests/test_guardrails_aggregator_comprehensive.py -v

# Provider tests
pytest tests/test_guardrails_providers_comprehensive.py -v

# Orchestrator wiring tests  
pytest tests/test_orchestrator_wiring_comprehensive.py -v

# Red Team corpus tests
pytest tests/test_redteam_corpus_integration.py -v
```

## Test Categories

### Unit Tests
- Individual provider functionality
- Aggregator logic components
- Deduplication service methods
- Report generation utilities

### Integration Tests  
- End-to-end guardrails flow
- Cross-suite deduplication
- Preflight → Red Team reuse
- Report generation with real data

### System Tests
- Go/No-Go validation harness
- Full API endpoint testing
- Performance characteristics
- Privacy compliance validation

## Privacy Compliance

All tests include assertions to ensure:
- ❌ No raw prompts in logs
- ❌ No raw LLM outputs in logs  
- ❌ No user data in cached signals
- ❌ No PII in fingerprints
- ✅ Only metrics and IDs in logs
- ✅ Masked/redacted content in reports
- ✅ Ephemeral user data handling

## Deterministic Behavior

All tests ensure:
- ✅ Identical inputs → identical outputs
- ✅ Fixed seeds for reproducible results
- ✅ Stable ordering in corpus selection
- ✅ Consistent fingerprint generation
- ✅ Deterministic ASR calculations

## Acceptance Criteria Status

- ✅ Coverage report shows ≥80% on core modules
- ✅ Go/No-Go harness passes end-to-end; artifacts/summary produced; outputs deterministic
- ✅ No raw text in logs; missing-dep cases degrade gracefully  
- ✅ Dedupe and gating behaviors proven by tests and harness output
- ✅ No regressions to Classic payload semantics; Classic UI ready for feature flag

## Files Modified/Created

### New Test Files
- `tests/test_guardrails_aggregator_comprehensive.py`
- `tests/test_guardrails_providers_comprehensive.py` 
- `tests/test_orchestrator_wiring_comprehensive.py`
- `tests/test_redteam_corpus_integration.py` (from previous task)

### New Scripts
- `scripts/go_no_go_validation.py`

### Modified Files
- `Makefile` - Added `test-coverage` and `go-no-go` targets

### Documentation
- `docs/P0.5_COVERAGE_AND_VALIDATION.md` (this file)

## Next Steps

1. **CI Integration**: Add coverage enforcement to CI pipeline
2. **Performance Monitoring**: Set up automated performance regression detection
3. **Security Scanning**: Add security-focused test cases
4. **Load Testing**: Validate system under realistic load conditions

The AI Quality Kit system is now production-ready with comprehensive test coverage and validation harness ensuring reliability, privacy, and performance.
